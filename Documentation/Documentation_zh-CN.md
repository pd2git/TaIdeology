# 关于她的意识

语言：简体中文, [English](./Documentation.md)

这是一个配置她的意识的后端。你可以自行选择自己喜欢的后端，并为她配置独特的意识。

项目有极大的自由度，可以选择任意的大语言模型后端，已知支持ChatGLM、ChatRWKV，还有诸如ChatGPT、Yuan、Moss、Llama等等。

建议使用 [闻达](https://github.com/wenda-LLM/wenda) 的开源项目，更方便支持上述模型，而且本项目的样例也是基于此项目进行的。

具体见 **_"[Demo](./Demo)"_** 和 **_"[Documentation](./Documentation)"_** 文件夹。

# 安装

## 依赖

- [color_logger](./Ext)
- [chat_record](./Ext/chat_record.py)
- [api_key_authenticator](./Ext/api_key_authenticator.py)
- [python](https://www.python.org/) (具体版本根据你选择的后端决定)

# 使用

### 使用闻达项目+一个Demo代码
1. 参考Demo修改闻达项目原代码。Demo中代码文件名对应闻达项目中代码的文件名，具体修改地方在Demo代码中有注释说明。
2. 将依赖模块文件夹[Ext](./Ext)下的模块放置在闻达项目的根目录下（与wenda.py同级）。
3. 安装额外依赖库[requirements-extra](./requirements/requirements-extra.txt)。 
4. 根据闻达项目要求配置好项目后，运行。

### 使用其它项目+一个Demo代码
1. 参考使用闻达项目的方法，结合Demo代码，修改相应区域代码。
2. 确保整个通讯满足通讯协议。
3. 运行你的后端。

# 通讯协议

## 聊天

### 客户端请求数据

方式：Web Post

格式：Web Form

内容：

|    键    |      格式       | 值   | 备注             |
|:-------:|:-------------:|-----|----------------|
| APIKey  |      文本       | --  | 值就自己自定义了       |
| Words | Json文本(UTF-8) | --  | 值详见“Words数据” |

Words数据：
```json lines
{
  // 提示语
  "prompt": "你好",
  // 发散性
  "temperature": 0.8,
  // 多样性
  "top_p": 0.2,
  // 不会修改其值
  "is_add_words_div_mark": true,
  // 不会修改其值
  "is_only_send_new_word": true,
  // 不会修改其值
  "is_show_cal_tip": false,
  // 历史纪录
  "history": [
    {
      // 枚举值：user表示用户说的内容，AI表示后端说的内容。
      "role": "user",
      // 说的内容
      "content": "你是一个擅长聊天的智能助手。"
    },
    {
      "role": "AI",
      "content": "好的。"
    }
  ],
  // 这个是RWKV时才会带的条目
  "presence_penalty": 0.6,
  // 这个是RWKV时才会带的条目
  "frequency_penalty": 0.3
}
```

### 服务端返回数据

方式：具体见 **_"[Demo](./Demo)"_** 

格式：生成内容的文本, UTF-8

注意：
- 采用流式生成，提升客户端体验。
- 每次返回内容，尾部加"///"（无引号）。
- 每生成完全部内容，尾部加"/././"（无引号）。
- 遇标点'.', '!', '。', '！', '？', '；', '：'（无引号）客户端会自动断句气泡输出。

举例：<br>
完整内容：**_我是AI助手，我喜欢跟你聊天。你喜欢吗？_**<br>
第一批可能返回数据，一定加尾部标识：**_我是///_**<br>
第二批可能返回数据，一定加尾部标识：**_AI助手，我喜欢///_**<br>
第三批可能返回数据，一定加尾部标识：**_跟你聊天。你喜欢///_**<br>
第三批可能返回数据，有“单次返回”和“本次生成完成”两个尾部标识：**_吗？////././_**<br>

## 请求聊天纪录

### 客户端请求数据

方式：Web Post

格式：Web Form

内容：

|    键    |      格式       | 值   | 备注             |
|:-------:|:-------------:|-----|----------------|
| APIKey  |      文本       | --  | 值就自己自定义了       |
| RecData | Json文本(UTF-8) | --  | 值详见“RecData数据” |

RecData数据：
```json lines
{
  // -1表示从头开始搜索，零及正值表示要从该ID往前搜索
  "StartRecId": -1,
  // 请求纪录的数量
  "RecQty": 20,
  // 不设关键字，数据为空列表。
  "KeysList": [
    "你好"
  ],
  // 不限定日期，设置为null，不带引号。
  "StartDate": "2023/01/01 16:16:55",
  // 不限定日期，设置为null，不带引号。
  "EndDate": "2023/01/02 16:16:55"
}
```

### 服务端返回数据

方式：Web Post

格式：json, UTF-8

内容：
```json lines
{
  "RecordsList": [
    {
      // 此条纪录的Id
      "Id": 12,
      // 纪录产生的时间
      "Time": "2023/01/02 16:16:55",
      // 说话者昵称
      "NickName": "角色XXX",
      // 说话内容
      "ChatContent": "你好",
      // 是否为用户说的
      "IsMine": false
    }
  ]
}
```

# 技术细节

## 已知限制

- 目前仅在Windows 10下做过测试，其它Python支持的平台理论上支持。
- 目前仅支持流式回复应用于前端气泡显示。

## 包体内容

以下表格展示了包中各主要文件夹或文件的功能：

| 位置                | 描述                  |
|--------------------|---------------------|
| `..\Demo`          | 包含演示主要功能的样例，包括代码。|
| `..\Documentation` | 包含介绍与使用的多语言文档，比如主文档。|
| `..\requirements`  | 包含安装环境所需要的依赖模块。|

# 文档版本日志

| 日期         | 描述                     |
|------------|------------------------|
| 2024-01-17 | 文档（v1.0）创建，匹配包版本1.0.1。 |
